---
import Layout from '../../layouts/Layout.astro'
import Footer from '../../components/Footer.astro'
import DogDetailGallery from '../../components/DogDetailGallery'
import { getPhotoUrl } from '../../utils/photo-url'
import { t, type Language } from '../../i18n'

const { id } = Astro.params

// Note: Language is determined by URL locale prefix when Astro i18n routing is enabled.
// Currently defaults to Polish. Full i18n URL routing is a future enhancement.
const lang = (Astro.currentLocale as Language) || 'pl'

function formatAge(months: number, lang: Language): string {
  const years = Math.floor(months / 12)
  if (months < 12) return `${months} ${t('card.months', lang)}`
  
  if (years === 1) return `~1 ${t('card.year', lang)}`
  
  if (lang === 'pl') {
    if (years >= 2 && years <= 4) return `~${years} ${t('card.years24', lang)}`
    return `~${years} ${t('card.years', lang)}`
  }
  
  return `~${years} ${t('card.years', lang)}`
}

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787'
const response = await fetch(`${API_URL}/dogs/${id}`)

if (!response.ok) {
  return Astro.redirect('/404')
}

const dog = await response.json()
dog.isRemoved = dog.status === 'removed'
const ogImage = (dog.photosGenerated?.[0] || dog.photos?.[0])
  ? getPhotoUrl(dog.photosGenerated?.[0] || dog.photos?.[0], 'lg')
  : undefined
---

<Layout title={`${dog.name} - Dogpile`} image={ogImage}>
  <main id="dog-detail-page" class="grain-overlay min-h-screen pt-12 pb-24 px-6">
    <div class={`max-w-4xl mx-auto ${dog.isRemoved ? 'opacity-60' : ''}`}>
      <a id="back-to-list-link" href="/" class="link-arrow mb-12">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        {t('dogDetail.backToList', lang)}
      </a>

      {dog.isRemoved && (
        <div class="bg-sys-state-urgent/10 border-2 border-sys-state-urgent text-sys-state-urgent p-4 mb-8 paper-edge text-center">
          <p class="font-bold text-lg">{t('dogDetail.notAvailable', lang)}</p>
          <p class="text-sm opacity-80 mt-1">{t('dogDetail.notAvailableDesc', lang)}</p>
        </div>
      )}

      <div class="bg-sys-paper-card paper-edge overflow-hidden p-8 md:p-12">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
          <!-- Photo Gallery -->
          <div class="lg:col-span-7">
            <div class="polaroid rotate-1 hover:rotate-0 transition-transform">
              <DogDetailGallery
                client:load
                photos={dog.photos || []}
                photosGenerated={dog.photosGenerated || []}
                alt={dog.name}
              />
            </div>
          </div>

          <!-- Content -->
          <div class="lg:col-span-5 space-y-8">
            <header>
              <div class="flex flex-wrap items-center gap-3 mb-2">
                <h1 class="text-6xl font-black">{dog.name}</h1>
                {dog.urgent && <span class="tag-urgent">{t('dogDetail.urgent', lang)}</span>}
              </div>
              <p class="text-xl font-narrative opacity-60">{t('dogDetail.tagline', lang)}</p>
            </header>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-4">
              {dog.ageEstimate && (
                <div class="bg-white/50 p-4 paper-edge-alt border-2 border-sys-paper-shadow flex flex-col items-center text-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-2 opacity-40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  <span class="text-xs font-bold uppercase tracking-wider opacity-40 mb-1">{t('dogDetail.age', lang)}</span>
                  <span class="font-title text-lg">{formatAge(dog.ageEstimate.months, lang)}</span>
                </div>
              )}
              {dog.sizeEstimate && (
                <div class="bg-white/50 p-4 paper-edge-alt border-2 border-sys-paper-shadow flex flex-col items-center text-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-2 opacity-40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 11V4h7M11 20h9v-7"/></svg>
                  <span class="text-xs font-bold uppercase tracking-wider opacity-40 mb-1">{t('dogDetail.size', lang)}</span>
                  <span class="font-title text-lg uppercase">{dog.sizeEstimate.value}</span>
                </div>
              )}
              {dog.breedEstimates?.[0] && (
                <div class="bg-white/50 p-4 paper-edge-alt border-2 border-sys-paper-shadow flex flex-col items-center text-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-2 opacity-40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                  <span class="text-xs font-bold uppercase tracking-wider opacity-40 mb-1">{t('dogDetail.breed', lang)}</span>
                  <span class="font-title text-lg">{dog.breedEstimates[0].breed}</span>
                </div>
              )}
              {dog.locationCity && (
                <div class="bg-white/50 p-4 paper-edge-alt border-2 border-sys-paper-shadow flex flex-col items-center text-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-2 opacity-40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                  <span class="text-xs font-bold uppercase tracking-wider opacity-40 mb-1">{t('dogDetail.location', lang)}</span>
                  <span class="font-title text-lg">{dog.locationCity}</span>
                </div>
              )}
            </div>

            <!-- Health & Compatibility -->
            <div class="space-y-4">
              <div class="flex flex-wrap gap-2">
                {dog.goodWithKids && <span class="tag-grass italic">{t('dogDetail.goodWithKids', lang)}</span>}
                {dog.goodWithDogs && <span class="tag-grass italic">{t('dogDetail.goodWithDogs', lang)}</span>}
                {dog.goodWithCats && <span class="tag-grass italic">{t('dogDetail.goodWithCats', lang)}</span>}
              </div>
              
              <div class="flex flex-wrap gap-4 text-sm font-bold opacity-60">
                {dog.vaccinated && <span class="flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-sys-nature-grass" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg> {t('dogDetail.vaccinated', lang)}</span>}
                {dog.sterilized && <span class="flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-sys-nature-grass" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg> {t('dogDetail.sterilized', lang)}</span>}
                {dog.chipped && <span class="flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-sys-nature-grass" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg> {t('dogDetail.chipped', lang)}</span>}
              </div>
            </div>

            {!dog.isRemoved && (
              <a id="contact-shelter-button" href={dog.sourceUrl} target="_blank" rel="noopener noreferrer" class="btn-primary w-full text-center block text-2xl lowercase">
                {t('dogDetail.contactShelter', lang)} {dog.shelterName ?? dog.name}
              </a>
            )}
          </div>
        </div>

        <!-- Bio & Tags -->
        <div class="mt-20 grid grid-cols-1 lg:grid-cols-12 gap-12">
          <div class="lg:col-span-8">
            <h2 class="text-4xl mb-6">{t('dogDetail.story', lang)}</h2>
            <blockquote class="bg-sys-cheek-blush/20 p-8 paper-edge-alt font-narrative text-2xl leading-relaxed italic border-l-4 border-sys-heart-soft">
              <p set:html={dog.generatedBio || dog.rawDescription} />
            </blockquote>
          </div>
          
          <div class="lg:col-span-4">
            {dog.personalityTags?.length > 0 && (
              <div class="space-y-6">
                <h3 class="text-3xl">{t('dogDetail.vibeCheck', lang)}</h3>
                <div class="flex flex-wrap gap-2">
                  {dog.personalityTags.map((tag: string) => (
                    <span class="tag-sky text-lg px-4 py-2">
                      #{tag}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </main>
  <Footer />
</Layout>
